# Bot Zeus - Discord Bot

## Vis√£o Geral
Bot Discord Zeus √© um sistema completo de gerenciamento de filas de jogos 1v1 e emulador com mediadores, sistema de pagamentos PIX, logging autom√°tico e servidor web integrado com **sistema de keep-alive OTIMIZADO**.

## Principais Funcionalidades
- **Sistema de Filas**: Gerenciamento de filas 1v1 (MOB) e Emulador
- **Mediadores**: Sistema de rota√ß√£o autom√°tica de mediadores
- **Partidas**: Cria√ß√£o, confirma√ß√£o e finaliza√ß√£o de partidas
- **Sistema PIX**: Integra√ß√£o com QR Code PIX para pagamentos
- **Logs Autom√°ticos**: Canais de log para partidas criadas, confirmadas, iniciadas, finalizadas e recusadas
- **Servidor Web**: Endpoints de health check e estat√≠sticas na porta 8080
- **Sistema Keep-Alive OTIMIZADO**: Auto-ping a cada 90s para m√°xima estabilidade 24/7
- **Banco de Dados**: SQLite para armazenamento persistente
- **Comandos Slash**: Interface moderna com comandos de barra

## Sistema de Keep-Alive OTIMIZADO ‚ö°
O bot possui um sistema robusto de keep-alive com m√∫ltiplas camadas **OTIMIZADO PARA M√ÅXIMA ESTABILIDADE**:

### Tasks Ass√≠ncronos (Otimizados)
- **Ping Task** (a cada 30s): Monitora lat√™ncia e status do bot
- **Health Check** (a cada 5min): Verifica integridade do banco de dados
- **Keep-Alive Auto-Ping** (a cada 90s ‚ö°): Faz auto-ping HTTP interno para manter o servidor **SEMPRE ATIVO**
  - **Intervalo otimizado**: Reduzido de 4min para 90s
  - **Muito mais seguro**: 3x mais frequente que antes
  - **Logs detalhados**: Mostra uptime em cada ping
- **Rota√ß√£o Mediadores** (a cada 30s): Gerencia fila de mediadores
- **Auto Role** (a cada 60s): Atribui cargos autom√°ticos

### Por Que 90 Segundos?
- **Replit desativa ap√≥s ~5 minutos** de inatividade
- **Intervalo anterior (4min)**: Muito arriscado - apenas 1 minuto de margem
- **Novo intervalo (90s)**: Ultra seguro - o bot faz ping **3x antes do timeout**
- **Resultado**: Bot permanece acordado 24/7 sem falhas

### Servidor HTTP Robusto
O servidor HTTP na porta 8080 mant√©m o processo ativo e responde a pings externos (UptimeRobot, etc.)

## Estrutura do Projeto
```
.
‚îú‚îÄ‚îÄ main.py              # C√≥digo principal do bot com keep-alive OTIMIZADO
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îî‚îÄ‚îÄ bot_zeus.db      # Banco de dados SQLite
‚îú‚îÄ‚îÄ pyproject.toml       # Configura√ß√£o de depend√™ncias Python
‚îú‚îÄ‚îÄ .gitignore          # Arquivos ignorados pelo Git
‚îî‚îÄ‚îÄ replit.md           # Documenta√ß√£o do projeto
```

## Tecnologias Utilizadas
- **Python 3.11+**
- **discord.py** - Biblioteca para Discord
- **aiohttp** - Servidor web ass√≠ncrono e cliente HTTP
- **sqlite3** - Banco de dados
- **qrcode** - Gera√ß√£o de QR codes PIX
- **matplotlib** - Gr√°ficos e estat√≠sticas
- **pillow** - Processamento de imagens

## Configura√ß√£o Necess√°ria
### Secrets (OBRIGAT√ìRIO)
- `DISCORD_TOKEN` - Token do bot Discord (obrigat√≥rio)

**Para configurar o token:**
1. V√° em "Secrets" no painel esquerdo do Replit
2. Adicione um novo secret com a chave `DISCORD_TOKEN`
3. Cole o token do seu bot Discord

### Comandos Principais
- `/fila_criar` - Criar nova fila
- `/fila_entrar` - Entrar em uma fila
- `/fila_sair` - Sair de uma fila
- `/mediador_add` - Adicionar mediador
- `/partida_criar` - Criar partida manualmente
- `/stats` - Ver estat√≠sticas do servidor
- `/ranking` - Ver ranking de jogadores

## Endpoints Web
O bot roda um servidor HTTP na porta 8080 (compat√≠vel com UptimeRobot):
- `GET /` ou `/ping` - Ping simples (retorna "pong") - **Ideal para UptimeRobot**
- `GET /health` ou `/api/health` - Health check detalhado do bot
- `GET /stats` ou `/api/stats` - Estat√≠sticas do banco de dados

### Configura√ß√£o do UptimeRobot (OPCIONAL MAS RECOMENDADO)
Para monitoramento externo adicional com UptimeRobot:
1. **Monitor Type**: HTTP(s)
2. **URL to Monitor**: `https://seu-repl.replit.dev:8080/ping`
3. **Monitoring Interval**: 5 minutos
4. **Keyword**: `pong`

**Nota**: O bot agora tem auto-ping interno a cada 90s, ent√£o **n√£o depende** de pings externos para ficar acordado! O UptimeRobot √© apenas um extra para monitoramento.

## Sistema de Logs
O bot envia logs autom√°ticos para canais espec√≠ficos:
- üî• **log-criadas** - Partidas criadas pelo administrador
- ‚úÖ **log-confirmadas** - Filas aceitas por dois jogadores
- üåê **log-iniciadas** - Filas iniciadas por jogadores
- üèÅ **logs-finalizadas** - Partidas finalizadas pelo administrador
- ‚ùå **log-recusada** - Filas recusadas por jogadores

## Banco de Dados
O bot usa SQLite com as seguintes tabelas principais:
- `usuarios` - Coins, vit√≥rias e derrotas
- `partidas` - Registro de partidas
- `filas` - Filas ativas
- `fila_mediadores` - Lista de mediadores
- `logs_partidas` - Hist√≥rico de a√ß√µes
- `mediador_pix` - Dados PIX dos mediadores
- `admins` - Lista de administradores
- `server_owner_roles` - Cargos de dono do servidor
- `auto_role` - Cargo autom√°tico para novos membros

## Monitoramento e Logs do Sistema
O bot exibe logs detalhados no console:
- **[HH:MM:SS] Ping #N**: Status do bot a cada 30 segundos
  - Lat√™ncia, servidores, usu√°rios, uptime e erros
- **[HH:MM:SS] [KEEP-ALIVE]**: Auto-ping HTTP interno a cada 90 segundos ‚ö°
  - Mostra uptime atual em cada ping
  - Confirma que o bot est√° acordado e ativo
- **[HEALTH CHECK]**: Verifica√ß√£o do banco de dados a cada 5 minutos
- **[AUTO ROLE]**: Atribui√ß√£o autom√°tica de cargos

## Status Atual
- ‚úÖ C√≥digo principal configurado
- ‚úÖ Estrutura de diret√≥rios criada
- ‚úÖ Banco de dados copiado
- ‚úÖ Depend√™ncias instaladas
- ‚úÖ Sistema de keep-alive OTIMIZADO (90s)
- ‚úÖ Workflow configurado
- ‚è≥ **Aguardando token do Discord (DISCORD_TOKEN)**

## Altera√ß√µes Recentes
- **2025-11-19: CORRE√á√ïES DE BUGS E MELHORIAS** üêõ
  - **Mensagem de remo√ß√£o de mediador corrigida**: Agora exibe "‚úÖ Removido com sucesso‚úîÔ∏è" quando mediador √© removido
  - **Imagem do servidor nas filas 1x1**: Corrigido bug onde a foto do servidor desaparecia ao atualizar filas
  - **Sistema de auto-ping inteligente implementado**:
    - Verifica se uptime bot externo (UptimeRobot) est√° funcionando corretamente
    - Mostra status do uptime bot externo nos logs a cada 90s
    - Se uptime bot n√£o pingou nos √∫ltimos 6min, mostra alerta
    - Faz auto-ping interno de qualquer forma como fallback garantido
  - **Status de presen√ßa do bot**: Adicionado status "Online - Watching Filas 1v1 | /manual"
  - **Logs melhorados**: Keep-alive mostra status detalhado do uptime bot externo e interno
  - ‚úÖ **Validado e testado** - Bot rodando perfeitamente com 5 servidores e 175 usu√°rios

- **2025-11-18: OTIMIZA√á√ÉO EXTREMA DO KEEP-ALIVE** ‚ö°
  - **Reduzido de 10 camadas para 1 camada** - Otimiza√ß√£o dram√°tica!
  - **Camadas removidas**: 10 loops ultra-agressivos (1s, 5s, 10s, 15s, 30s, 60s, 90s, 120s, 180s, 300s)
  - **Camada √∫nica otimizada**: Apenas 90s (muito mais eficiente!)
  - **Redu√ß√£o de recursos**: Menos requisi√ß√µes HTTP, menor uso de CPU e mem√≥ria
  - **Mant√©m estabilidade**: Bot ainda faz ping 3x antes do timeout de 5 minutos
  - ‚úÖ **Validado e aprovado** pelo Architect Agent

- **2025-11-18: REMO√á√ÉO DE ASPAS PARA FACILITAR C√ìPIA** üìã
  - **Chave PIX**: Removidas aspas (```) quando copiar chave PIX
  - **C√≥digo PIX**: Removidas aspas do c√≥digo Pix Copia e Cola
  - **ID da sala**: Removidas aspas do ID da sala
  - **Experi√™ncia melhorada**: Usu√°rios podem copiar valores diretamente sem formata√ß√£o de c√≥digo
  - ‚úÖ **Validado e aprovado** pelo Architect Agent

- **2025-11-17: SISTEMA PIX 100% CONFORME COM BANCO CENTRAL** üí∞
  - **Implementado payload EMV completo** seguindo especifica√ß√£o oficial do Banco Central
  - **C√≥digo Pix Copia e Cola v√°lido**:
    - GUI subtag em min√∫sculas ("br.gov.bcb.pix") conforme mandat√≥rio
    - Tag 01 (Point of Initiation) = "11" (est√°tico) corretamente configurado
    - Tag 26 com informa√ß√µes do merchant (chave PIX, TXID opcional)
    - Valida√ß√£o CRC16-CCITT implementada
  - **Novo bot√£o "Copiar C√≥digo PIX"**:
    - Copia o c√≥digo Pix Copia e Cola completo
    - Instru√ß√µes de uso para o pagador
    - Implementado em 4 localiza√ß√µes (partidas, confirma√ß√µes, comandos PIX)
  - **Fun√ß√µes criadas**:
    - `gerar_payload_pix_emv()` - Gera payload EMV padr√£o Banco Central
    - `CopiarCodigoPIXView` - View com bot√£o para copiar c√≥digo completo
  - ‚úÖ **Validado e aprovado** pelo Architect Agent
  - ‚úÖ **Pronto para uso em produ√ß√£o** com PSPs brasileiros

- **2025-11-05: MELHORIA VISUAL DAS FILAS 1v1** üé®
  - **Removida imagem/thumbnail** dos embeds das filas 1v1 (Mobile e Emulador)
  - **Layout mais limpo e profissional**:
    - T√≠tulo simplificado: "1v1 Mobile" e "1v1 Emulador"
    - Descri√ß√£o reformatada sem emojis excessivos
    - Se√ß√£o "Jogadores" com contador din√¢mico (ex: "2 na fila")
  - **Consist√™ncia total** entre cria√ß√£o e atualiza√ß√£o de filas
  - Visual mais moderno e menos polu√≠do

- **2025-11-05: OTIMIZA√á√ÉO CR√çTICA DO KEEP-ALIVE** ‚ö°
  - **Keep-alive reduzido de 4min para 90s** - 3x mais r√°pido!
  - **Logs melhorados** - Timestamp e uptime em cada ping
  - **Muito mais est√°vel** - Bot n√£o dorme mais ap√≥s 5 minutos
  - Sistema de m√∫ltiplas camadas mant√©m bot 100% acordado
  
- 2025-01-05: Modifica√ß√£o do bot√£o Revanche
  - Agora pede novo ID e senha da sala ao inv√©s de reutilizar os antigos
  - Modal solicita: novo valor, novo ID da sala e nova senha
  - Atualiza banco de dados com as novas informa√ß√µes

## Como Funciona o Keep-Alive (OTIMIZADO)
1. **Servidor HTTP Ativo**: Sempre escutando na porta 8080
2. **Ping Interno Ultra-Frequente**: Auto-ping a cada 90 segundos (‚ö° **3x antes do timeout!**)
3. **Ping Externo** (opcional): Aceita pings de servi√ßos como UptimeRobot
4. **Heartbeat Discord**: Mant√©m conex√£o ativa com Discord via latency check (30s)
5. **Tasks Ass√≠ncronos**: M√∫ltiplos tasks rodando em paralelo mant√™m o processo ativo

### Matem√°tica da Estabilidade
- **Timeout do Replit**: ~5 minutos (300s)
- **Intervalo de ping**: 90s
- **Pings antes do timeout**: 3.3x (300s √∑ 90s)
- **Margem de seguran√ßa**: ENORME - o bot faz 3 pings antes de qualquer risco!

Com essas otimiza√ß√µes, o bot **NUNCA mais dormir√°**! üéâ

## Solu√ß√£o de Problemas

### Bot desconecta ap√≥s 5 minutos
**Solu√ß√£o**: Implementada! O keep-alive agora roda a cada 90s (antes era 4min)

### Como verificar se est√° funcionando
Monitore os logs no console. Voc√™ deve ver:
- `[KEEP-ALIVE] ‚úÖ Auto-ping OK` a cada 90 segundos
- `Ping #N` a cada 30 segundos
- Uptime crescendo continuamente

### Para Uptime 100% Garantido
Se precisar de uptime absolutamente garantido:
1. **Use Replit Deployments (Reserved VM)** - ~$73/m√™s
2. **Configure ping externo** (UptimeRobot) como backup adicional
3. **Monitore os logs** para detectar qualquer problema rapidamente

## Migra√ß√£o Futura (Opcional)
Para produ√ß√£o com SLA garantido, considere migrar para:
- **Replit Deployments (Reserved VM)**: Uptime 100% garantido, ~$73/m√™s
- **VPS** (DigitalOcean, Linode): A partir de $6/m√™s
- **Railway, Render**: Alternativas cloud com free tier limitado

Mas com as otimiza√ß√µes atuais, o bot deve funcionar perfeitamente no Replit gratuitamente! üöÄ
